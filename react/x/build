#!/bin/bash
set -e

BUILD_TYPE=production
CACHE_RELOAD=no

while [ $# -gt 0 ]; do
    case "$1" in
        development | develop | dev )
            BUILD_TYPE=development
            ;;
        production | prod )
            BUILD_TYPE=production
            ;;
        clean )
            BUILD_TYPE=clean
            ;;
        --reload )
            CACHE_RELOAD=yes
            ;;
        * )
            echo "Usage: build [--reload] BUILD_TYPE"
            echo
            echo "BUILD_TYPE: production | prod"
            echo "            development | develop | dev"
            echo "            clean"
            false
    esac
    shift
done

IMPORT_MAP="--import-map import_map.json"
LOCK="--lock lock.json"
if [ "$BUILD_TYPE" = "development" ]; then
    IMPORT_MAP="--import-map dev_import_map.json"
    LOCK=""
fi

if [ "$CACHE_RELOAD" == "yes" ]; then
    LOCK_WRITE=""
    if [ "$LOCK" != "" ]; then
        LOCK_WRITE="--lock-write"
    fi
    deno cache --reload $LOCK_WRITE $LOCK $IMPORT_MAP app.tsx html.tsx serve.ts
fi

if [ "$BUILD_TYPE" = "clean" ]; then
    rm -rf build
    exit 0
fi

OUT_DIR="build/$BUILD_TYPE"
rm -rf $OUT_DIR
mkdir -p "$OUT_DIR"
deno bundle $LOCK $IMPORT_MAP serve.ts "$OUT_DIR/serve.js"
deno bundle $LOCK $IMPORT_MAP app.tsx "$OUT_DIR/app.js"
deno run $LOCK $IMPORT_MAP html.tsx > "$OUT_DIR/app.html"
